using System.Text.Json;
using System.Net.Http.Json;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;

public async Task FetchScripts()
{
    HttpClient client = new HttpClient();
    try
    {
        JsonElement scripts = await client.GetFromJsonAsync<JsonElement>("https://scriptblox.com/api/script/fetch"); 
        foreach (JsonElement script in scripts.GetProperty("result").GetProperty("scripts"))
        {
            Application.Current.Dispatcher.Invoke(() =>
            {
                // Main card container
                Border card = new Border()
                {
                    Width = 380,
                    Height = 270,
                    Background = new SolidColorBrush(Color.FromRgb(24, 24, 24)), // Dark gray card
                    CornerRadius = new CornerRadius(12),
                    Padding = new Thickness(12),
                    Margin = new Thickness(10),
                    Effect = new System.Windows.Media.Effects.DropShadowEffect()
                    {
                        Color = Colors.Black,
                        BlurRadius = 10,
                        ShadowDepth = 2
                    }
                };

                StackPanel content = new StackPanel();

                // Title
                TextBlock title = new TextBlock()
                {
                    Text = script.GetProperty("title").GetString(),
                    FontSize = 18,
                    FontWeight = FontWeights.Bold,
                    Foreground = Brushes.White
                };
                content.Children.Add(title);

                // Game name
                if (script.TryGetProperty("game", out JsonElement game))
                {
                    TextBlock gameName = new TextBlock()
                    {
                        Text = game.GetProperty("name").GetString(),
                        FontSize = 14,
                        Foreground = Brushes.LightGray,
                        Margin = new Thickness(0, 2, 0, 6)
                    };
                    content.Children.Add(gameName);
                }

                // Description
                if (script.TryGetProperty("description", out JsonElement description))
                {
                    TextBlock desc = new TextBlock()
                    {
                        Text = description.GetString(),
                        FontSize = 13,
                        TextWrapping = TextWrapping.Wrap,
                        Foreground = Brushes.Gray,
                        Margin = new Thickness(0, 0, 0, 10)
                    };
                    content.Children.Add(desc);
                }

                // Tags (horizontal)
                if (script.TryGetProperty("tags", out JsonElement tags) && tags.ValueKind == JsonValueKind.Array)
                {
                    StackPanel tagPanel = new StackPanel()
                    {
                        Orientation = Orientation.Horizontal,
                        Margin = new Thickness(0, 5, 0, 10)
                    };

                    foreach (JsonElement tag in tags.EnumerateArray())
                    {
                        Border tagBox = new Border()
                        {
                            Background = new SolidColorBrush(Color.FromRgb(255, 140, 0)), // orange
                            CornerRadius = new CornerRadius(10),
                            Padding = new Thickness(8, 4, 8, 4),
                            Margin = new Thickness(0, 0, 5, 0)
                        };

                        TextBlock tagText = new TextBlock()
                        {
                            Text = tag.GetString(),
                            Foreground = Brushes.Black,
                            FontSize = 12,
                            FontWeight = FontWeights.SemiBold
                        };

                        tagBox.Child = tagText;
                        tagPanel.Children.Add(tagBox);
                    }

                    content.Children.Add(tagPanel);
                }

                // Footer info (views, likes, date)
                StackPanel footer = new StackPanel()
                {
                    Orientation = Orientation.Horizontal,
                    HorizontalAlignment = HorizontalAlignment.SpaceBetween
                };

                TextBlock views = new TextBlock()
                {
                    Text = $"ðŸ‘ {script.GetProperty("views").GetInt32()}",
                    Foreground = Brushes.LightGray,
                    FontSize = 12,
                    Margin = new Thickness(0, 0, 15, 0)
                };

                TextBlock likes = new TextBlock()
                {
                    Text = $"â¤ï¸ {script.GetProperty("likes").GetInt32()}",
                    Foreground = Brushes.LightGray,
                    FontSize = 12,
                    Margin = new Thickness(0, 0, 15, 0)
                };

                TextBlock date = new TextBlock()
                {
                    Text = $"ðŸ“… {script.GetProperty("updatedAt").GetString()}",
                    Foreground = Brushes.LightGray,
                    FontSize = 12
                };

                footer.Children.Add(views);
                footer.Children.Add(likes);
                footer.Children.Add(date);

                content.Children.Add(footer);

                card.Child = content;
                ScriptPanel.Children.Add(card);
            });
        }
    }
    catch (HttpRequestException e)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            ScriptPanel.Children.Add(new TextBlock()
            {
                Text = $"Network error while fetching scripts:\n{e.Message}",
                Margin = new Thickness(10)
            });
        });
    }
    catch (JsonException e)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            ScriptPanel.Children.Add(new TextBlock()
            {
                Text = $"Error parsing JSON response:\n{e.Message}",
                Margin = new Thickness(10)
            });
        });
    }
    catch (Exception e)
    {
        Application.Current.Dispatcher.Invoke(() =>
        {
            ScriptPanel.Children.Add(new TextBlock()
            {
                Text = $"Unexpected error:\n{e.Message}",
                Margin = new Thickness(10)
            });
        });
    }
}
